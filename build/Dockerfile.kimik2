FROM nvcr.io/nvidia/l4t-base:r36.2.0

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Fix CUDA paths (use literal paths, not variables, to avoid Docker warnings)
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/lib/aarch64-linux-gnu

# Install system dependencies (including TensorRT Python bindings from JetPack)
RUN apt-get update && apt-get install -y \
    git \
    git-lfs \
    python3 \
    python3-pip \
    python3-dev \
    python3-mpi4py \
    python3-numpy \
    cmake \
    build-essential \
    ninja-build \
    libopenmpi-dev \
    openmpi-bin \
    libncurses5-dev \
    libssl-dev \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip3 install --upgrade pip setuptools wheel

# Clone TensorRT-LLM jetson-specific branch
WORKDIR /workspace
RUN git clone --recursive --branch v0.12.0-jetson https://github.com/NVIDIA/TensorRT-LLM.git
WORKDIR /workspace/TensorRT-LLM

# Pull Git LFS files
RUN git lfs install && git lfs pull

# CRITICAL FIX: Remove tensorrt packages from requirements.txt (x86_64 only)
# These conflict with Jetson's pre-installed TensorRT
RUN sed -i '/tensorrt/d' requirements.txt
RUN sed -i '/tensorrt-cu12/d' requirements.txt
RUN sed -i '/tensorrt-bindings/d' requirements.txt

# Install Python requirements (without tensorrt packages)
RUN pip3 install -r requirements.txt

# Verify system TensorRT is installed
RUN python3 -c "import tensorrt; print(f'TensorRT version: {tensorrt.__version__}')" || echo "Warning: TensorRT Python bindings may need manual installation"

# Build TensorRT-LLM wheel WITHOUT NCCL and using system TensorRT
# The --trt_root flag is CRITICAL for Jetson
RUN python3 scripts/build_wheel.py \
    --jetsons \
    --clean \
    --use_ccache \
    --trt_root /usr/lib/aarch64-linux-gnu \
    --cuda_architectures "87-real" \
    --extra-cmake-vars "USE_NCCL=OFF;TRTLLM_ENABLE_NCCL=0;CMAKE_CUDA_ARCHITECTURES=87"

# Install the built wheel
RUN pip3 install ./build/tensorrt_llm-*.whl

# Final verification
RUN python3 -c "import tensorrt_llm; print('TensorRT-LLM installed successfully')"

WORKDIR /workspace
CMD ["/bin/bash"]